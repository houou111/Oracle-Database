SET MARKUP HTML ON SPOOL ON PREFORMAT OFF ENTMAP ON -
HEAD "<TITLE>DEPARTMENT REPORT</TITLE> -
<STYLE TYPE='TEXT/CSS'> -
<!-- BODY {BACKGROUND: #FFFFC6} --> -
</STYLE>" -
BODY "TEXT='#FF0000'" -
TABLE "WIDTH='90%' BORDER='1'"

SET ECHO OFF
SET VERIFY OFF
SET TRIMSPOOL ON
SET TRIMOUT ON
SET LINESIZE 9999
SET FEEDBACK OFF
SET TIMING OFF
SET TIME OFF
COLUMN NAME FORMAT A50

COLUMN DBSIZE HEADING 'DATABASE SIZE [GB]'
COLUMN CTIME HEADING 'DATE'

COLUMN NAME HEADING 'ASM NAME'
COLUMN START_TIME HEADING 'START TIME'
COLUMN TOTAL_MB HEADING 'TOTAL [GB]'
COLUMN USED_MB HEADING 'USED [GB]'
COLUMN FREE_MB HEADING 'FREE [GB]'
COLUMN USED_PERCENT HEADING '% USED'
COLUMN CF FORMAT 9,999
COLUMN DF FORMAT 9,999
COLUMN I0 FORMAT 9,999
COLUMN I1 FORMAT 9,999
COLUMN L FORMAT 9,999
COLUMN OUTPUT_GB FORMAT 9,999,999 HEADING "OUTPUT|GB"
COLUMN STATUS FORMAT A10 TRUNC
COLUMN FLASHBACK_ON HEADING 'FLASHBACK ENABLE ?'

SPOOL ./DB_INFO2.HTML
--RUNING TIME
-- DB SIZE
SELECT ROUND(SUM(BYTES)/1024/1024/1024,2) DBSIZE FROM V$DATAFILE_HEADER;

--BACKUP
SELECT
  TO_CHAR(J.START_TIME, 'DD-MM-YYYY HH24:MI:SS') START_TIME,
  ROUND(J.OUTPUT_BYTES/1024/1024/1024,3) OUTPUT_GBYTES, J.STATUS,
  DECODE(TO_CHAR(J.START_TIME, 'D'), 1, 'SUNDAY', 2, 'MONDAY',
                                     3, 'TUESDAY', 4, 'WEDNESDAY',
                                     5, 'THURSDAY', 6, 'FRIDAY',
                                     7, 'SATURDAY') DOW,
  X.DF, X.I0, X.I1, X.L
FROM V$RMAN_BACKUP_JOB_DETAILS J
  LEFT OUTER JOIN (SELECT
                     D.SESSION_RECID, D.SESSION_STAMP,
                     SUM(CASE WHEN D.CONTROLFILE_INCLUDED = 'YES' THEN D.PIECES ELSE 0 END) CF,
                     SUM(CASE WHEN D.CONTROLFILE_INCLUDED = 'NO'
                               AND D.BACKUP_TYPE||D.INCREMENTAL_LEVEL = 'D' THEN D.PIECES ELSE 0 END) DF,
                     SUM(CASE WHEN D.BACKUP_TYPE||D.INCREMENTAL_LEVEL = 'D0' THEN D.PIECES ELSE 0 END) I0,
                     SUM(CASE WHEN D.BACKUP_TYPE||D.INCREMENTAL_LEVEL = 'I1' THEN D.PIECES ELSE 0 END) I1,
                     SUM(CASE WHEN D.BACKUP_TYPE = 'L' THEN D.PIECES ELSE 0 END) L
                   FROM
                     V$BACKUP_SET_DETAILS D
                     JOIN V$BACKUP_SET S ON S.SET_STAMP = D.SET_STAMP AND S.SET_COUNT = D.SET_COUNT
                   WHERE S.INPUT_FILE_SCAN_ONLY = 'NO'
                   GROUP BY D.SESSION_RECID, D.SESSION_STAMP) X
    ON X.SESSION_RECID = J.SESSION_RECID AND X.SESSION_STAMP = J.SESSION_STAMP
  LEFT OUTER JOIN (SELECT O.SESSION_RECID, O.SESSION_STAMP, MIN(INST_ID) INST_ID
                   FROM GV$RMAN_OUTPUT O
                   GROUP BY O.SESSION_RECID, O.SESSION_STAMP)
    RO ON RO.SESSION_RECID = J.SESSION_RECID AND RO.SESSION_STAMP = J.SESSION_STAMP
WHERE J.START_TIME > TRUNC(SYSDATE)-7
ORDER BY J.START_TIME;

--ASM
SELECT NAME ,ROUND(TOTAL_MB/1024,2) TOTAL_MB,
        ROUND((TOTAL_MB-FREE_MB)/1024,2) USED_MB,
        ROUND(FREE_MB/1024,2) FREE_MB,
        ROUND((TOTAL_MB-FREE_MB)/TOTAL_MB*100) USED_PERCENT
FROM V$ASM_DISKGROUP;

--ARCHIVE LOG
ARCHIVE LOG LIST;

--FLASHBACK
SELECT FLASHBACK_ON FROM V$DATABASE;
SHOW PARAMETER DB_RECOVERY_FILE_DEST;
SELECT NAME, SPACE_LIMIT, SPACE_USED, SPACE_USED/SPACE_LIMIT*100 "PERCENT USED", NUMBER_OF_FILES FROM V$RECOVERY_FILE_DEST;

SPOOL OFF
EXIT